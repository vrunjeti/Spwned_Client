"use strict";angular.module("spwnedApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/login.html",controller:"MainCtrl",controllerAs:"main"}).when("/login",{templateUrl:"views/login.html",controller:"MainCtrl",controllerAs:"main"}).when("/register",{templateUrl:"views/register.html",controller:"MainCtrl",controllerAs:"main"}).when("/games",{templateUrl:"views/games.html",controller:"GamesCtrl",controllerAs:"games"}).when("/games/:gameid/admin",{templateUrl:"views/admin.html",controller:"AdminCtrl",controllerAs:"admin"}).when("/games/:gameid/admin/kills",{templateUrl:"views/kills.html",controller:"AdminCtrl",controllerAs:"kills"}).when("/messages/g/:gameid/u/:userid",{templateUrl:"views/messages.html",controller:"MessagesCtrl",controllerAs:"messages"}).when("/games/:gameid/player",{templateUrl:"views/playerpanel.html",controller:"PlayerpanelCtrl",controllerAs:"player"}).otherwise({redirectTo:"/"})}]),angular.module("spwnedApp").controller("MainCtrl",["Users","$http","$window","$location","$scope",function(a,b,c,d,e){var f=this;e.$on("$viewContentLoaded",function(){f.currentUser=c.sessionStorage.userId,f.messageUrl="#/messages/p/"+f.currentUser}),f.registerUser=function(b){a.registerUser(b).error(function(a){f.registerErrorMsg=a.data}).success(function(a){f.registerMsg=a.message,f.login(b)})},f.login=function(b){console.log(b),a.login(b).error(function(a){f.loginErrorMsg=a.data}).success(function(a){c.sessionStorage.userId=a.data._id,f.formData={},d.path("/games")})},f.getUserAccount=function(b){a.getUserAccount(b).error(function(a){}).success(function(a){})},f.dummyLogin=function(){f.isLoggedIn()||(c.sessionStorage.userId="Dummy token for testing purposes")},f.isLoggedIn=function(){return null!==c.sessionStorage.userId&&void 0!==c.sessionStorage.userId},f.logout=function(){f.isLoggedIn()&&(c.sessionStorage.clear(),d.path("/login"))}}]),angular.module("spwnedApp").controller("GamesCtrl",["Game","Users","$http","$window","$location","$scope","$route",function(a,b,c,d,e,f,g){var h=this;h.isInGame=[],h.gameHasStarted=[],f.$on("$viewContentLoaded",function(){h.getAllGames("",!1),h.getUserAccount(d.sessionStorage.userId),h.currUserId=d.sessionStorage.userId}),$(document).ready(function(){$(".modal-trigger").leanModal(),$(".datepicker").pickadate({selectMonths:!0,selectYears:5})}),h.getUserAccount=function(a){b.getUserAccount(a).error(function(a){}).success(function(a){h.userInfo=a.data})},h.getAllGames=function(b,c){a.getAllGames(b,c).error(function(a){}).success(function(a){h.allGames=a.data})},h.createGame=function(b){b.userId=d.sessionStorage.userId,a.createGame(b).error(function(a){}).success(function(a){g.reload()})},h.getGame=function(b){a.getGame(b,d.sessionStorage.userId).error(function(a){}).success(function(a){null!==a.data.admin_token?(d.sessionStorage[b]=a.data.admin_token,e.path("/games/"+a.data._id+"/admin")):null!==a.data.player_token&&(d.sessionStorage[b]=a.data.player_token,e.path("/games/"+a.data._id+"/player"))})},h.joinGame=function(b,c){a.joinGame(b,c).error(function(a){}).success(function(a){h.getGame(a.data.game_id)})},h.deleteGame=function(b){a.deleteGame(b).error(function(a){}).success(function(a){})},h.storeAdminId=function(a){if(""===d.sessionStorage.adminKeys){var b=[];b.push(a);var c=JSON.stringify(b);d.sessionStorage.adminKeys=c}else{var e=JSON.parse(d.sessionStorage.adminKeys);e.push(a);var c=JSON.stringify(e);d.sessionStorage.adminKeys=c}},h.storePlayerId=function(a){if(""===d.sessionStorage.playerKeys){var b=[];b.push(a);var c=JSON.stringify(b);d.sessionStorage.playerKeys=c}else{var e=JSON.parse(d.sessionStorage.playerKeys);e.push(a);var c=JSON.stringify(e);d.sessionStorage.playerKeys=c}}}]),angular.module("spwnedApp").controller("AdminCtrl",["Admin","Game","Player","Users","$http","$scope","$routeParams","$window","$location",function(a,b,c,d,e,f,g,h,i){var j=this;j.currentGame=g.gameid,j.allKillersList=[],j.allTargetsList=[],j.finalKillsList=[],f.$on("$viewContentLoaded",function(){j.getGame(j.currentGame),j.getKills(j.currentGame,j.createFinalKillsList)}),$(document).ready(function(){$(".modal-trigger").leanModal(),$(".datepicker").pickadate({selectMonths:!0,selectYears:5})}),j.deleteGame=function(b,c){console.log("adminID is "+b),console.log(c),a.deleteGame(b,c).success(function(a){console.log("User Deleted!"),i.path("/games")})},j.removePlayer=function(b,c,d){a.removePlayer(b,c,d).error(function(a){}).success(function(a){})},j.startGame=function(b,c){console.log("gameID is: "+c),a.startGame(b,c).error(function(a){}).success(function(a){console.log("Game Created!"),i.path("/games")})},j.getGame=function(a){b.getGame(a,h.sessionStorage.userId).error(function(a){}).success(function(a){j.gameInfo=a.data})},j.getKills=function(b,e){a.getKills(b).error(function(a){}).success(function(a){j.allKills=a.data,console.log(j.allKills);for(var b=0;b<j.allKills.length;b++)c.getPlayer(j.allKills[b].killer_id).success(function(a){d.getUserAccount(a.data.user_id).success(function(a){j.allKillersList.push(a.data.first_name)})});for(var f=0;f<j.allKills.length;f++)c.getPlayer(j.allKills[f].target_id).success(function(a){d.getUserAccount(a.data.user_id).success(function(a){j.allTargetsList.push(a.data.first_name),j.allTargetsList.length===j.allKills.length&&e()})})})},j.createFinalKillsList=function(){for(var a=0;a<j.allKillersList.length;a++)console.log(j.allKills[a]),j.finalKillsList[a]={killer:j.allKillersList[a],target:j.allTargetsList[a],timeOfKill:moment(j.allKills[a].timeOfKill).format("MMMM Do YYYY, h:mm:ss a")}}}]),angular.module("spwnedApp").controller("MessagesCtrl",["Game","Users","Messages","$scope","$http","$window","$location","$routeParams",function(a,b,c,d,e,f,g,h){$(document).ready(function(){$(".modal-trigger").leanModal()}),d.rid="",d.user=f.sessionStorage.userId,a.getGame(d.gameid).success(function(a){var b=a.data;d.admin_id=b.admin_id,d.isAdmin=b.admin_id===d.user,console.log(d.isAdmin)}),b.getAllUsers().success(function(a){d.users=[],a.data.forEach(function(a){if(a._id!=h.userid){var b=a.games.indexOf(h.gameid);b>-1&&(a.name=a.first_name+" "+a.last_name,d.users.push(a))}})}),c.getMessages(h.gameid,h.userid).success(function(a){d.msgs=a.data,a.data.forEach(function(a){b.getUserAccount(a.sender_id).success(function(b){a.sender=b.data.first_name+" "+b.data.last_name}),b.getUserAccount(a.recipient_id).success(function(b){a.recipient=b.data.first_name+" "+b.data.last_name})})}),d.sendMsg=function(){var a={game_id:h.gameid,sender_id:h.userid,recipient:d.rec,body:d.body};console.log(a),c.sendMessage(h.gameid,h.userid,a).success(function(a){g.path("/messages/g/"+h.gameid+"/u/"+h.userid)}).error(function(a){console.log(a)})},d.setRec=function(a){d.rec=a}}]),angular.module("spwnedApp").controller("PlayerpanelCtrl",["Users","Player","Game","$http","$scope","$routeParams","$window",function(a,b,c,d,e,f,g){var h=this;h.currentGame=f.gameid,h.currPlayerId=g.sessionStorage[h.currentGame],h.killList=[],e.$on("$viewContentLoaded",function(){h.getUserAccount(g.sessionStorage.userId),h.getPlayer(g.sessionStorage[h.currentGame]),h.getGameInfo(h.currentGame)}),h.getUserAccount=function(b){a.getUserAccount(b).error(function(a){}).success(function(a){h.userInfo=a.data})},h.getPlayer=function(a){b.getPlayer(a).error(function(a){}).success(function(a){console.log(a),h.playerInfo=a.data,h.getNextTarget();for(var b=0;b<h.playerInfo.killed.length;b++)h.getKillById(h.playerInfo.killed[b])})},h.getKillById=function(a){b.getKillById(a).success(function(a){h.getUserAccountByPlayerId(a.data.target_id)})},h.getUserAccountByPlayerId=function(a){b.getPlayer(a).success(function(a){h.getUserAccountByUserId(a.data.user_id)})},h.getUserAccountByUserId=function(b){a.getUserAccount(b).error(function(a){}).success(function(a){h.killList.push(a.data)})},h.getNextTarget=function(){console.log(h.playerInfo),b.getPlayer(h.playerInfo.target_id).success(function(b){a.getUserAccount(b.data.user_id).success(function(a){h.nextTarget=a.data})})},h.getGameInfo=function(a){c.getGame(a,g.sessionStorage.userId).error(function(a){}).success(function(a){h.gameInfo=a.data})},h.getAllPlayers=function(a,c,d){b.getAllPlayers(a,c,d).error(function(a){}).success(function(a){})},h.reportKill=function(a,c){b.reportKill(a,c).error(function(a){}).success(function(a){$route.reload()})}}]),angular.module("spwnedApp").factory("Messages",["$http",function(a){var b="http://45.55.224.229:4000/api/";return{getMessages:function(c,d){return a.get(b+"message/g/"+c+"/u/"+d)},sendMessage:function(c,d,e){return a.post(b+"message/g/"+c+"/u/"+d,e)}}}]),angular.module("spwnedApp").factory("Player",["$http",function(a){var b="http://45.55.224.229:4000/api/";return{getAllPlayers:function(c,d,e){return a.get(b+c+"/players",{params:{where:d,count:e}})},getPlayer:function(c){return a.get(b+"player/"+c)},reportKill:function(c,d){return a.put(b+"player/report",{player_id:c,secret_code:d})},getPlayerKills:function(c,d){return a.get(b+"kills",{params:{game_id:c,killer_id:d}})},getKillById:function(c){return a.get(b+"kill/"+c)}}}]),angular.module("spwnedApp").factory("Users",["$http",function(a){var b="http://45.55.224.229:4000/api/";return{registerUser:function(c){return a.post(b+"register",{first_name:c.firstName,last_name:c.lastName,email:c.email,password:c.password})},login:function(c){return console.log(c),a.post(b+"signin",{email:c.email,password:c.password})},getUserAccount:function(c){return a.get(b+"user/"+c)},getAllUsers:function(){return a.get(b+"user")}}}]),angular.module("spwnedApp").factory("Game",["$http",function(a){var b="http://45.55.224.229:4000/api/";return{getAllGames:function(c,d){return a.get(b+"game",{params:{where:c,count:d}})},createGame:function(c){return a.post(b+"game",{title:c.title,description:c.description,user_id:c.userId,start_date:c.startDate,end_date:c.endDate,capacity:c.capacity})},getGame:function(c,d){return a.get(b+"game/"+c,{params:{user_id:d}})},joinGame:function(c,d){return a.put(b+"game/"+c+"/join",{user_id:d})},deleteGame:function(c){return a["delete"](b+"game"+c)}}}]),angular.module("spwnedApp").factory("Admin",["$http",function(a){var b="http://45.55.224.229:4000/api/";return{deleteGame:function(c,d){return a.put(b+"admin/delete_game",{admin_id:c,game_id:d})},removePlayer:function(c,d,e){return a.put(b+"deletePlayer",{params:{admin_id:c,player_id:d,game_id:e}})},startGame:function(c,d){return a.put(b+"admin/start",{admin_id:c,game_id:d})},getKills:function(c){return a.get(b+"kills",{params:{game_id:c}})}}}]);